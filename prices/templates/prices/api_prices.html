<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Обновления цен API</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">Обновления цен API</h1>
    <!-- Форма для выбора символа -->
    <div class="row mb-3">
      <div class="col-md-4 offset-md-4">
        <select id="symbol" class="form-select">
          <option value="BTCUSDT" selected>BTC/USDT</option>
          <option value="ETHUSDT">ETH/USDT</option>
          <option value="LTCUSDT">LTC/USDT</option>
          <option value="XRPUSDT">XRP/USDT</option>
          <option value="BNBUSDT">BNB/USDT</option>
          <option value="ADAUSDT">ADA/USDT</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="card-body text-center">
        <h2 id="price" class="display-4">--</h2>
        <p class="text-muted" id="updated">Ожидание обновления цены...</p>
      </div>
    </div>
  </div>

  <script>
    let socket;

    function connectWebSocket(symbol) {
      if (socket) {
        socket.close();
      }
      const wsUrl = 'ws://' + window.location.host + '/ws/api/prices/' + symbol + '/';
      socket = new WebSocket(wsUrl);

      socket.onopen = function(event) {
        console.log("Подключено к ws/api/prices для", symbol, event);
      };

      socket.onmessage = function(event) {
        console.log("Получено сообщение:", event.data);
        try {
          const data = JSON.parse(event.data);
          if (data.price) {
            document.getElementById('price').textContent = data.price;
            document.getElementById('updated').textContent =
              "Обновлено: " + new Date().toLocaleTimeString();
          }
        } catch (e) {
          console.error("Ошибка при разборе сообщения:", e);
        }
      };

      socket.onclose = function(event) {
        console.log("Соединение закрыто:", event);
      };

      socket.onerror = function(error) {
        console.error("Ошибка WebSocket:", error);
      };
    }

    // Устанавливаем соединение при загрузке страницы
    const coinSelector = document.getElementById('symbol');
    connectWebSocket(coinSelector.value);

    // При смене валюты переподключаемся
    coinSelector.addEventListener('change', function() {
      connectWebSocket(this.value);
    });
  </script>
</body>
</html>
